<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="요리 레시피 검색, 인분 계산, 단계별 타이머, 음성 이동을 지원하는 실전용 레시피 앱">
  <meta name="build-id" content="2026-02-13-recipe-v2">
  <title>Recipe Cocy</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --accent: #0f766e;
      --accent-soft: #ccfbf1;
      --shadow: 0 10px 24px rgba(17, 24, 39, 0.08);
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Pretendard", "Noto Sans KR", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top right, #e6fffa 0%, var(--bg) 45%);
    }
    .app {
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 14px;
      min-height: 100vh;
    }
    .top {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      display: grid;
      gap: 12px;
    }
    .brand {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .title {
      margin: 0;
      font-size: 1.45rem;
      letter-spacing: -0.01em;
    }
    .subtitle {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 0.92rem;
    }
    .controls {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr auto auto;
      gap: 8px;
    }
    input, select, button {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.95rem;
      background: #fff;
      color: var(--text);
    }
    button {
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.15s ease, background-color 0.2s ease;
    }
    button:hover { transform: translateY(-1px); }
    .btn-main {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .btn-sub {
      background: #fff;
      color: var(--text);
    }
    .content {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      min-height: 0;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-height: 0;
    }
    .list-panel {
      display: grid;
      grid-template-rows: auto 1fr;
    }
    .list-head {
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      color: var(--muted);
      font-size: 0.9rem;
    }
    .recipe-list {
      overflow: auto;
      padding: 8px;
      display: grid;
      gap: 8px;
    }
    .recipe-item {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
      transition: border-color 0.2s ease, background-color 0.2s ease;
      background: #fff;
    }
    .recipe-item:hover {
      border-color: #9ca3af;
      background: #fcfcfd;
    }
    .recipe-item.active {
      border-color: var(--accent);
      background: var(--accent-soft);
    }
    .recipe-name {
      font-weight: 700;
      margin: 0 0 6px;
      font-size: 0.98rem;
    }
    .recipe-meta {
      margin: 0;
      color: var(--muted);
      font-size: 0.83rem;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .detail {
      display: grid;
      grid-template-rows: auto auto 1fr;
      min-height: 0;
    }
    .detail-head {
      padding: 16px;
      border-bottom: 1px solid var(--line);
      display: grid;
      gap: 8px;
    }
    .detail-title {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: -0.01em;
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .chip {
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #e5e7eb;
    }
    .serving-row {
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .serving-row label {
      color: var(--muted);
      font-size: 0.9rem;
      margin-right: 4px;
    }
    .num-box {
      width: 72px;
      text-align: center;
      font-weight: 700;
    }
    .detail-body {
      overflow: auto;
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-content: start;
    }
    .section {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      background: #fff;
    }
    .section h2 {
      margin: 0 0 10px;
      font-size: 1.02rem;
    }
    .ingredients {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 8px;
    }
    .ingredients li {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      font-size: 0.92rem;
      border-bottom: 1px dashed #e5e7eb;
      padding-bottom: 6px;
    }
    .instructions {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 10px;
    }
    .instructions li {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      display: grid;
      gap: 8px;
      background: #fff;
    }
    .step-head {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }
    .step-no { font-weight: 700; }
    .timer-btn {
      border: 1px solid #86efac;
      background: #f0fdf4;
      color: #166534;
      padding: 5px 9px;
      border-radius: 999px;
      font-size: 0.78rem;
      cursor: pointer;
      white-space: nowrap;
    }
    .step-image {
      width: 100%;
      max-height: 220px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--line);
    }
    .footer {
      color: var(--muted);
      font-size: 0.8rem;
      padding-top: 6px;
    }
    .toast {
      position: fixed;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(17, 24, 39, 0.92);
      color: #fff;
      border-radius: 999px;
      padding: 10px 16px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 9999;
      font-size: 0.9rem;
    }
    .toast.show { opacity: 1; }
    @media (max-width: 1024px) {
      .controls { grid-template-columns: 1fr 1fr; }
      .content { grid-template-columns: 1fr; }
      .detail-body { grid-template-columns: 1fr; }
      .list-panel { max-height: 38vh; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="top">
      <div class="brand">
        <div>
          <h1 class="title">Recipe Cocy</h1>
          <p class="subtitle">118개 레시피, 인분 자동 계산, 단계별 타이머, 음성 이동</p>
        </div>
        <button id="voice-toggle" class="btn-sub" type="button">음성 시작</button>
      </div>
      <div class="controls">
        <input id="search-input" type="search" placeholder="레시피 이름 검색 (예: 김치, 파스타)">
        <select id="category-select">
          <option value="all">전체 카테고리</option>
        </select>
        <button id="sort-btn" class="btn-sub" type="button">이름순</button>
        <button id="random-btn" class="btn-main" type="button">랜덤 추천</button>
      </div>
    </header>

    <main class="content">
      <section class="panel list-panel">
        <div class="list-head" id="list-head">로딩 중...</div>
        <div id="recipe-list" class="recipe-list"></div>
      </section>

      <section class="panel detail">
        <div class="detail-head">
          <h2 id="recipe-title" class="detail-title">레시피 로딩 중...</h2>
          <div id="chips" class="chips"></div>
        </div>
        <div class="serving-row">
          <label for="servings-input">인분</label>
          <button id="serving-minus" class="btn-sub" type="button">-</button>
          <input id="servings-input" class="num-box" type="number" min="1" value="2">
          <button id="serving-plus" class="btn-sub" type="button">+</button>
          <span id="calories-text" style="margin-left:auto;color:#374151;font-weight:700;">총 0 kcal</span>
        </div>
        <div class="detail-body">
          <section class="section">
            <h2>재료</h2>
            <ul id="ingredient-list" class="ingredients"></ul>
          </section>
          <section class="section">
            <h2>조리 순서</h2>
            <ol id="instruction-list" class="instructions"></ol>
          </section>
          <div class="footer">Build: <span id="build-id">2026-02-13-recipe-v2</span></div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const state = {
      recipes: {},
      keys: [],
      filteredKeys: [],
      currentKey: null,
      currentServings: 2,
      sortMode: "name",
      voiceOn: false,
      recognition: null,
      ttsAllowed: true
    };

    const els = {
      searchInput: document.getElementById("search-input"),
      categorySelect: document.getElementById("category-select"),
      sortBtn: document.getElementById("sort-btn"),
      randomBtn: document.getElementById("random-btn"),
      voiceToggle: document.getElementById("voice-toggle"),
      listHead: document.getElementById("list-head"),
      recipeList: document.getElementById("recipe-list"),
      recipeTitle: document.getElementById("recipe-title"),
      chips: document.getElementById("chips"),
      servingsInput: document.getElementById("servings-input"),
      servingMinus: document.getElementById("serving-minus"),
      servingPlus: document.getElementById("serving-plus"),
      caloriesText: document.getElementById("calories-text"),
      ingredientList: document.getElementById("ingredient-list"),
      instructionList: document.getElementById("instruction-list"),
      toast: document.getElementById("toast")
    };

    function showToast(message) {
      els.toast.textContent = message;
      els.toast.classList.add("show");
      setTimeout(() => els.toast.classList.remove("show"), 1400);
    }

    function sanitizeText(value) {
      return String(value ?? "").trim();
    }

    function extractTime(text) {
      const tokens = [...text.matchAll(/(\d+)\s*(시간|분|초)/g)];
      if (tokens.length === 0) return null;
      let ms = 0;
      const labelParts = [];
      tokens.forEach((m) => {
        const n = parseInt(m[1], 10);
        const unit = m[2];
        if (unit === "시간") ms += n * 3600000;
        if (unit === "분") ms += n * 60000;
        if (unit === "초") ms += n * 1000;
        labelParts.push(`${n}${unit}`);
      });
      if (ms <= 0) return null;
      return { ms, label: labelParts.join(" ") };
    }

    function beep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.frequency.value = 880;
        osc.type = "sine";
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        setTimeout(() => osc.stop(), 180);
      } catch (_) {}
    }

    function speak(text) {
      if (!state.ttsAllowed) return;
      if (!("speechSynthesis" in window)) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "ko-KR";
      window.speechSynthesis.speak(utter);
    }

    function startStepTimer(timeInfo) {
      showToast(`${timeInfo.label} 타이머 시작`);
      speak(`${timeInfo.label} 타이머를 시작합니다.`);
      setTimeout(() => {
        beep();
        showToast(`${timeInfo.label} 종료`);
        speak(`${timeInfo.label}이 경과했습니다.`);
      }, timeInfo.ms);
    }

    function toDifficultyLabel(level) {
      if (level === "easy") return "난이도 쉬움";
      if (level === "hard") return "난이도 어려움";
      return "난이도 보통";
    }

    function calcCalories(ingredient, adjustedAmount) {
      const basis = ingredient.calorie_basis || ((ingredient.unit === "g" || ingredient.unit === "ml") ? "per_100" : "per_unit");
      if (basis === "per_100") {
        return (adjustedAmount * Number(ingredient.calories_per_unit || 0)) / 100;
      }
      return adjustedAmount * Number(ingredient.calories_per_unit || 0);
    }

    function getCurrentRecipe() {
      return state.recipes[state.currentKey];
    }

    function renderRecipeList() {
      els.recipeList.innerHTML = "";
      const fragment = document.createDocumentFragment();
      state.filteredKeys.forEach((key) => {
        const recipe = state.recipes[key];
        const item = document.createElement("button");
        item.type = "button";
        item.className = `recipe-item${key === state.currentKey ? " active" : ""}`;
        item.dataset.key = key;
        item.innerHTML = `
          <p class="recipe-name">${recipe.name}</p>
          <p class="recipe-meta">
            <span>${recipe.category || "기타"}</span>
            <span>${recipe.servings}인분 기준</span>
            <span>${recipe.cook_time_minutes || "-"}분</span>
          </p>
        `;
        item.addEventListener("click", () => selectRecipe(key));
        fragment.appendChild(item);
      });
      els.recipeList.appendChild(fragment);
      els.listHead.textContent = `총 ${state.filteredKeys.length}개 레시피`;
    }

    function renderRecipeDetail() {
      const recipe = getCurrentRecipe();
      if (!recipe) return;

      document.body.style.background = `linear-gradient(160deg, ${recipe.color || "#f6f7fb"}22 0%, #f6f7fb 48%)`;
      els.recipeTitle.textContent = recipe.name;
      els.servingsInput.value = state.currentServings;

      els.chips.innerHTML = "";
      const chips = [
        recipe.category || "기타",
        `${recipe.cook_time_minutes || "-"}분`,
        toDifficultyLabel(recipe.difficulty || "medium"),
        `${recipe.servings}인분 기준`
      ];
      chips.forEach((text) => {
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.textContent = text;
        els.chips.appendChild(chip);
      });

      let totalCalories = 0;
      els.ingredientList.innerHTML = "";
      recipe.ingredients.forEach((ingredient) => {
        const adjusted = (Number(ingredient.amount) / Number(recipe.servings || 1)) * state.currentServings;
        totalCalories += calcCalories(ingredient, adjusted);
        const li = document.createElement("li");
        li.innerHTML = `
          <span>${sanitizeText(ingredient.name)}</span>
          <strong>${adjusted.toFixed(1)} ${sanitizeText(ingredient.unit)}</strong>
        `;
        els.ingredientList.appendChild(li);
      });
      els.caloriesText.textContent = `총 ${Math.round(totalCalories)} kcal`;

      els.instructionList.innerHTML = "";
      recipe.instructions.forEach((step) => {
        const li = document.createElement("li");
        const text = sanitizeText(step.description);
        const timeInfo = extractTime(text);
        li.innerHTML = `
          <div class="step-head">
            <span class="step-no">Step ${step.step}</span>
            ${timeInfo ? `<button type="button" class="timer-btn" data-time="${timeInfo.ms}" data-label="${timeInfo.label}">${timeInfo.label} 타이머</button>` : ""}
          </div>
          <div>${text}</div>
        `;

        const img = document.createElement("img");
        img.className = "step-image";
        img.loading = "lazy";
        img.alt = `step ${step.step}`;
        img.src = `images/${state.currentKey}/${step.step}.png`;
        img.onerror = () => img.remove();
        li.appendChild(img);
        els.instructionList.appendChild(li);
      });

      els.instructionList.querySelectorAll(".timer-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          startStepTimer({
            ms: Number(btn.dataset.time),
            label: btn.dataset.label
          });
        });
      });
    }

    function selectRecipe(key) {
      if (!state.recipes[key]) return;
      state.currentKey = key;
      const savedServings = parseInt(localStorage.getItem("servings"), 10);
      if (!Number.isFinite(savedServings) || savedServings < 1) {
        state.currentServings = state.recipes[key].servings || 2;
      }
      localStorage.setItem("lastRecipe", key);
      renderRecipeList();
      renderRecipeDetail();
    }

    function applyFilters() {
      const q = sanitizeText(els.searchInput.value).toLowerCase();
      const category = els.categorySelect.value;
      let keys = [...state.keys];

      if (q) {
        keys = keys.filter((key) => state.recipes[key].name.toLowerCase().includes(q));
      }
      if (category !== "all") {
        keys = keys.filter((key) => (state.recipes[key].category || "기타") === category);
      }
      if (state.sortMode === "name") {
        keys.sort((a, b) => state.recipes[a].name.localeCompare(state.recipes[b].name, "ko"));
      } else if (state.sortMode === "time") {
        keys.sort((a, b) => (state.recipes[a].cook_time_minutes || 999) - (state.recipes[b].cook_time_minutes || 999));
      }
      state.filteredKeys = keys;

      if (!state.filteredKeys.includes(state.currentKey)) {
        state.currentKey = state.filteredKeys[0] || null;
      }
      renderRecipeList();
      renderRecipeDetail();
    }

    function setupCategories() {
      const categories = new Set(["all"]);
      state.keys.forEach((key) => categories.add(state.recipes[key].category || "기타"));
      els.categorySelect.innerHTML = "";
      [...categories].forEach((cat) => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat === "all" ? "전체 카테고리" : cat;
        els.categorySelect.appendChild(opt);
      });
    }

    function normalizeRecipe(key, value) {
      const recipe = { ...value };
      if (!recipe.category) {
        if (key.startsWith("popular")) recipe.category = "인기";
        else recipe.category = "기타";
      }
      if (!recipe.difficulty) recipe.difficulty = "medium";
      if (!recipe.cook_time_minutes) recipe.cook_time_minutes = 25;
      recipe.ingredients = Array.isArray(recipe.ingredients) ? recipe.ingredients : [];
      recipe.instructions = Array.isArray(recipe.instructions) ? recipe.instructions : [];
      return recipe;
    }

    function bindEvents() {
      els.searchInput.addEventListener("input", applyFilters);
      els.categorySelect.addEventListener("change", applyFilters);
      els.sortBtn.addEventListener("click", () => {
        state.sortMode = state.sortMode === "name" ? "time" : "name";
        els.sortBtn.textContent = state.sortMode === "name" ? "이름순" : "조리시간순";
        applyFilters();
      });
      els.randomBtn.addEventListener("click", () => {
        if (state.filteredKeys.length === 0) return;
        const key = state.filteredKeys[Math.floor(Math.random() * state.filteredKeys.length)];
        selectRecipe(key);
        showToast(`${state.recipes[key].name} 추천`);
      });

      els.servingMinus.addEventListener("click", () => {
        state.currentServings = Math.max(1, state.currentServings - 1);
        els.servingsInput.value = state.currentServings;
        localStorage.setItem("servings", String(state.currentServings));
        renderRecipeDetail();
      });
      els.servingPlus.addEventListener("click", () => {
        state.currentServings = Math.min(20, state.currentServings + 1);
        els.servingsInput.value = state.currentServings;
        localStorage.setItem("servings", String(state.currentServings));
        renderRecipeDetail();
      });
      els.servingsInput.addEventListener("input", () => {
        const n = parseInt(els.servingsInput.value, 10);
        if (!Number.isFinite(n) || n < 1) return;
        state.currentServings = Math.min(20, n);
        localStorage.setItem("servings", String(state.currentServings));
        renderRecipeDetail();
      });

      els.voiceToggle.addEventListener("click", toggleVoiceControl);
      document.body.addEventListener("touchstart", () => { state.ttsAllowed = true; }, { once: true });
      document.body.addEventListener("mousedown", () => { state.ttsAllowed = true; }, { once: true });
    }

    function moveStep(direction) {
      const items = [...els.instructionList.querySelectorAll("li")];
      if (items.length === 0) return;
      let closest = 0;
      let min = Number.MAX_SAFE_INTEGER;
      items.forEach((item, idx) => {
        const d = Math.abs(item.getBoundingClientRect().top - 120);
        if (d < min) {
          min = d;
          closest = idx;
        }
      });
      const next = Math.min(items.length - 1, Math.max(0, closest + direction));
      items[next].scrollIntoView({ behavior: "smooth", block: "center" });
      showToast(`Step ${next + 1}`);
    }

    function handleVoiceCommand(command) {
      const text = command.trim().toLowerCase();
      if (!text) return;

      if (text.includes("다음")) {
        moveStep(1);
        return;
      }
      if (text.includes("이전")) {
        moveStep(-1);
        return;
      }
      const servingsMatch = text.match(/(\d+)\s*인분/);
      if (servingsMatch) {
        state.currentServings = Math.max(1, parseInt(servingsMatch[1], 10));
        localStorage.setItem("servings", String(state.currentServings));
        renderRecipeDetail();
        showToast(`${state.currentServings}인분 적용`);
        return;
      }
      for (const key of state.filteredKeys) {
        const name = state.recipes[key].name.toLowerCase();
        if (text.includes(name)) {
          selectRecipe(key);
          showToast(`${state.recipes[key].name} 이동`);
          return;
        }
      }
    }

    function stopVoiceRecognition() {
      if (!state.recognition) return;
      state.voiceOn = false;
      state.recognition.onend = null;
      state.recognition.stop();
      state.recognition = null;
      els.voiceToggle.textContent = "음성 시작";
      showToast("음성 제어 종료");
    }

    function toggleVoiceControl() {
      if (state.voiceOn) {
        stopVoiceRecognition();
        return;
      }
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        showToast("이 브라우저는 음성 인식을 지원하지 않습니다");
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = "ko-KR";
      recognition.continuous = true;
      recognition.interimResults = false;
      recognition.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript;
        handleVoiceCommand(transcript);
      };
      recognition.onend = () => {
        if (!state.voiceOn) return;
        try {
          recognition.start();
        } catch (_) {}
      };
      try {
        recognition.start();
      } catch (_) {
        showToast("음성 인식 시작 실패");
        return;
      }
      state.recognition = recognition;
      state.voiceOn = true;
      els.voiceToggle.textContent = "음성 중지";
      showToast("음성 제어 시작");
    }

    async function init() {
      bindEvents();
      const response = await fetch(`recipes.json?t=${Date.now()}`);
      const payload = await response.json();
      const normalized = {};
      Object.entries(payload).forEach(([key, value]) => {
        normalized[key] = normalizeRecipe(key, value);
      });
      state.recipes = normalized;
      state.keys = Object.keys(normalized);

      setupCategories();

      const savedServings = parseInt(localStorage.getItem("servings"), 10);
      state.currentServings = Number.isFinite(savedServings) && savedServings > 0 ? savedServings : 2;

      const savedKey = localStorage.getItem("lastRecipe");
      state.currentKey = state.recipes[savedKey] ? savedKey : state.keys[0];
      applyFilters();
    }

    window.addEventListener("beforeunload", () => {
      stopVoiceRecognition();
    });
    window.addEventListener("keydown", (e) => {
      if (e.key === "ArrowDown") moveStep(1);
      if (e.key === "ArrowUp") moveStep(-1);
    });

    init().catch((err) => {
      console.error(err);
      showToast("초기화 실패");
    });
  </script>
</body>
</html>
